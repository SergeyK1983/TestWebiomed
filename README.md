## "Тестовое задание"

## Реализация сервисов с использованием Apache Kafka, Django, Celery

---

### Первый сервис (Producer). Прием чеков покупок клиентов
### Второй сервис (Consumer). Прием чеков из первого сервиса посредством Apache Kafka. Аналитика.

---
Технологии:\
API: Django - Django REST framework - PostgreSQL - Nginx - Docker\
Периодическая задача: Celery - Redis\
Брокер сообщений: Apache Kafka
___

Развертывание:

После клонирования файлы:
  - Consumer/consumer/django_db_wait.sh
  - Consumer/consumer/django_init.sh
  - Producer/producer/django_db_wait.sh
  - Producer/producer/django_init.sh

открыть в редакторе Notepad++ и через раздел Правка -> Формат Конца Строк -> Преобразовать в Unix (LF), сохранить.\
далее:
1. Из корневой директории "docker-compose up -d" (контейнер с Apache Kafka)
2. Из директории Producer "docker-compose up -d" (контейнер с 1 сервисом)
3. Из директории Consumer "docker-compose up -d" (контейнер со 2 сервисом)

Документация 1 сервис: http://localhost:8000/swagger/ \
Документация 2 сервис: http://localhost:9000/swagger/ \
Файлы .env выложил, чтобы не было дополнительных доработок.

Три сборки докер-контейнеров собраны в сеть. Сборка с Apache Kafka должна быть запущена первой.

---
Принцип действия:\
POST запросом отправляем чек на 1 сервис. На странице администратора 2 сервиса можно контролировать прием 
обработанных чеков от Apache Kafka.

---
В каждом сервисе будет создан суперпользователь.

    Данные для ввода:
    username: admin
    password: admin

---
Для просмотра данных во 2 сервисе необходимо зарегистрировать пользователя и выполнить вход (например через Postman).

    Регистрация (http://localhost:9000/auth/registration/):
    {
        "username": "my_name",
        "password1": "secret",
        "password2": "secret"
    }
    
    Вход (http://localhost:9000/auth/login/):
    {
        "username": "my_name",
        "password": "secret"
    }

После получения токена можно будет выполнять GET запросы (Authorization: Token d23a74d...). Для просмотра данных 
аналитики на странице администратора созданному пользователю необходимо проставить "галочку" "Аналитик" и сохранить. 

После запуска в папках Producer и Consumer будет создана папка .journal, в которой будет находиться файл journal.
В 1 сервисе в файл будет записываться информация о присланных чеках. Во 2 сервисе в файл будет записываться
информация о срабатывании расчета по аналитике.

Аналитика:\
Данные по покупкам накапливаются. Данные по налогам и чаевым добавляются как новые записи из расчета полученных 
данных на каждый час.

---
Эндпоинты:

1 Сервис:\
POST http://localhost:8000/api/checks/ - отправка чеков

2 Сервис:\
GET http://localhost:9000/api/places/ - просмотр мест покупок\
GET http://localhost:9000/api/analytics/ - просмотр общей аналитики\
GET http://localhost:9000/api/analytics/place_id/ - просмотр общей аналитики по месту покупки

POST http://localhost:9000/api/add_checks/ - принять чек\
POST http://localhost:9000/auth/login/ \
POST http://localhost:9000/auth/registration/

---
Пример чека (для обоих сервисов)

    {
        "transaction_id": "unique_transaction_id",
        "timestamp": "2024-02-07T12:34:56",
        "items": [
            {
                "product_id": "product_id_1",
                "quantity": 2,
                "price": 10.99,
                "category": "groceries"
            },
            {
                "product_id": "product_id_2",
                "quantity": 1,
                "price": 5.49,
                "category": "electronics"
            }
        ],
        "total_amount": 27.47,
        "nds_amount": 2.47,
        "tips_amount": 3.0,
        "payment_method": "credit_card",
        "place_id": "011",
        "place_name": "Магазин №1"
    }

Указанные поля обязательны, по ним выполняется валидация. Дополнительные поля значения не имеют.

---
Выполнено:

Сервис 1:
- прием чеков покупок с клиентов
- валидация чеков
- запись в журнал всех полученных чеков
- сохранение данных в БД
- отправка полученных чеков сервису 2 посредством Apache Kafka

Сервис 2:
- прием чеков из сервиса 1 посредством Apache Kafka
- разбиение содержимого чеков на привязку к местам покупок и дополнительной информации
- сохранение данных в БД
- расчет аналитики:
  - количество покупок в каждом месте
  - средний чек в каждом месте
  - общая сумма налогов и чаевых за промежуток времени
  - аналитика по категориям товаров
- запуск расчетов каждый час с использованием Celery
- использование токенов для аутентификации и авторизации
- разграничение доступа к различным частям в зависимости от ролей
